{% extends 'base.html' %}
{% block content %}
<div class="card">
    <h2>Tư vấn mua xe (AHP + ML)</h2>
    <div class="small">Nhập tối thiểu 2 xe để hệ thống xếp hạng và gợi ý phương án.</div>
</div>

<div class="card">
    <form method="post" action="{{ url_for('recommend') }}">
        <h3>1) Chấm điểm mức độ quan trọng (1-9)</h3>
        <div class="grid">
            {% for c in criteria %}
            <div class="col-3">
                <label>{{ c.label }}</label>
                <input type="number" min="1" max="9" name="w_{{ c.key }}" value="{{ c.default }}" required />
            </div>
            {% endfor %}
        </div>

        <h3>2) Thông tin xe (tối thiểu 2)</h3>
        <div class="small">Mẹo: MPG có thể để trống. Nếu đã nhập 1 trường của xe thì cần nhập đủ các trường bắt buộc.
        </div>

        <div class="flash danger client-errors" style="display:none"></div>

        <div data-car-form="1" data-min="2">
            {% if current_user.is_authenticated %}
            <div class="card saved-import" style="margin:10px 0;">
                <div class="small"><b>Chọn từ “Xe của tôi”</b> — lấy xe đã lưu để đưa vào form (có thể chỉnh sửa, không
                    ảnh hưởng dữ liệu đã lưu).</div>
                <div class="actions" style="margin-top:8px;">
                    <select class="saved-car-select" style="min-width:260px"></select>
                    <button class="btn secondary btn-import-saved" type="button">Thêm vào danh sách</button>
                </div>
            </div>
            {% endif %}
            <div class="actions" style="margin:10px 0;">
                <div class="small">Thêm/xoá xe tuỳ ý. Hệ thống vẫn bỏ qua xe để trống.</div>
                <button class="btn secondary btn-add-car" type="button">+ Thêm xe</button>
            </div>

            <div class="car-list">
                {% for i in range(0, 2) %}
                <div class="card car-card" data-prefix="car" data-index="{{ i }}" style="margin:12px 0;">
                    <div class="actions">
                        <b class="car-title">Xe #{{ i+1 }}</b>
                        <button class="btn danger btn-remove-car" type="button">Xóa</button>
                    </div>
                    <div class="grid">
                        <div class="col-4"><label>Giá bán ($) *</label><input name="car{{i}}_price" type="number"
                                step="1" placeholder="15000" /></div>
                        <div class="col-4"><label>Số dặm *</label><input name="car{{i}}_mileage" type="number" step="1"
                                placeholder="60000" /></div>
                        <div class="col-4"><label>Năm sản xuất *</label><input name="car{{i}}_year" type="number"
                                step="1" placeholder="2018" /></div>

                        <div class="col-4"><label>Tai nạn/Hỏng hóc *</label>
                            <select name="car{{i}}_accidents_or_damage">
                                <option value="">-- Chọn --</option>
                                <option value="0">0 - Không</option>
                                <option value="1">1 - Có</option>
                            </select>
                        </div>
                        <div class="col-4"><label>Một chủ duy nhất *</label>
                            <select name="car{{i}}_one_owner">
                                <option value="">-- Chọn --</option>
                                <option value="0">0 - Nhiều chủ</option>
                                <option value="1" selected>1 - Một chủ</option>
                            </select>
                        </div>
                        <div class="col-4"><label>MPG (Tiêu thụ nhiên liệu)</label><input name="car{{i}}_mpg"
                                type="text" placeholder="30 hoặc 39-38" /></div>

                        <div class="col-4"><label>Đánh giá lái xe (0-5)</label>
                            <select name="car{{i}}_driver_rating">
                                <option value="">-- Chọn --</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="col-4"><label>Đánh giá người bán (0-5)</label>
                            <select name="car{{i}}_seller_rating">
                                <option value="">-- Chọn --</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="col-4"><label>Giảm giá ($)</label><input name="car{{i}}_price_drop" type="number"
                                step="1" placeholder="500" /></div>
                    </div>
                    <div class="hint">* Bắt buộc nếu xe có nhập dữ liệu.</div>
                </div>
                {% endfor %}
            </div>

            <template>
                <div class="card car-card" data-prefix="car" data-index="__INDEX__" style="margin:12px 0;">
                    <div class="actions">
                        <b class="car-title">Xe</b>
                        <button class="btn danger btn-remove-car" type="button">Xóa</button>
                    </div>
                    <div class="grid">
                        <div class="col-4"><label>Giá bán ($) *</label><input name="car__INDEX___price" type="number"
                                step="1" placeholder="15000" /></div>
                        <div class="col-4"><label>Số dặm *</label><input name="car__INDEX___mileage" type="number"
                                step="1" placeholder="60000" /></div>
                        <div class="col-4"><label>Năm sản xuất *</label><input name="car__INDEX___year" type="number"
                                step="1" placeholder="2018" /></div>

                        <div class="col-4"><label>Tai nạn/Hỏng hóc *</label>
                            <select name="car__INDEX___accidents_or_damage">
                                <option value="">-- Chọn --</option>
                                <option value="0">0 - Không</option>
                                <option value="1">1 - Có</option>
                            </select>
                        </div>
                        <div class="col-4"><label>Một chủ duy nhất *</label>
                            <select name="car__INDEX___one_owner">
                                <option value="">-- Chọn --</option>
                                <option value="0">0 - Nhiều chủ</option>
                                <option value="1" selected>1 - Một chủ</option>
                            </select>
                        </div>
                        <div class="col-4"><label>MPG (Tiêu thụ nhiên liệu)</label><input name="car__INDEX___mpg"
                                type="text" placeholder="30 hoặc 39-38" /></div>

                        <div class="col-4"><label>Đánh giá lái xe (0-5)</label>
                            <select name="car__INDEX___driver_rating">
                                <option value="">-- Chọn --</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="col-4"><label>Đánh giá người bán (0-5)</label>
                            <select name="car__INDEX___seller_rating">
                                <option value="">-- Chọn --</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="col-4"><label>Giảm giá ($)</label><input name="car__INDEX___price_drop"
                                type="number" step="1" placeholder="500" /></div>
                    </div>
                    <div class="hint">* Bắt buộc nếu xe có nhập dữ liệu.</div>
                </div>
            </template>
        </div>

        <button class="btn" type="submit">Tính điểm & Gợi ý</button>
    </form>
</div>

{% if results %}
<div class="card">
    <h3>Kết quả</h3>
    <table class="table">
        <thead>
            <tr>
                <th>#</th>
                <th>Phương án</th>
                <th>AHP score</th>
                <th>Rủi ro tai nạn (ML)</th>
                <th>Chi phí bảo dưỡng (ML)</th>
                <th>Gợi ý</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for r in results %}
            <tr>
                <td>{{ r.idx }}</td>
                <td>
                    <span class="badge {{ r.badge }}">{{ r.option }}</span>
                </td>
                <td>{{ '%.3f'|format(r.ahp_score) }}</td>
                <td><span class="badge {{ r.risk_level_badge }}">{{ r.risk_level_label }}</span></td>
                <td><span class="badge {{ r.maintenance_level_badge }}">{{ r.maintenance_level_label }}</span></td>
                <td>{{ r.message }}</td>
                <td>
                    {% if current_user.is_authenticated and cars %}
                    <form method="post" action="{{ url_for('save_my_cars') }}">
                        <input type="hidden" name="source" value="manual" />
                        <input type="hidden" name="title" value="Xe #{{ r.idx }}" />
                        <textarea name="car_json" style="display:none">{{ cars[r.idx-1]|tojson }}</textarea>
                        <button class="btn secondary" type="submit">Lưu</button>
                    </form>
                    {% else %}
                    <a class="btn secondary" href="{{ url_for('login') }}">Đăng nhập</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if top_recommendations %}
    <h4>Top đề xuất</h4>
    <div class="small">Chỉ hiển thị phương án xanh.</div>
    <ul>
        {% for r in top_recommendations %}
        <li>Xe #{{ r.idx }} — {{ r.message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
</div>
{% endif %}
{% endblock %}